name: Setup build environment
description: Installs nix and optionally qemu, sets up caches

inputs:
  system:
    description: 'The system to setup'
    default: 'x86_64-linux'
  cachixAuthToken:
    description: 'The token to use to authenticate with cachix'
runs:
  using: "composite"
  steps:
    - uses: wimpysworld/nothing-but-nix@main
    - uses: samueldr/lix-gha-installer-action@v2025-10-27
      with:
        extra_nix_config: |
          extra-experimental-features = flakes nix-command pipe-operator
          system = ${{ inputs.system }}
    - uses: DeterminateSystems/magic-nix-cache-action@v8
      with:
        upstream-cache: https://lpchaim.cachix.org
    - uses: cachix/cachix-action@v15
      with:
        name: lpchaim
        authToken: ${{ inputs.cachixAuthToken }}
