name: Update flake inputs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * SAT"

jobs:
  update:
    name: Update flake
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: ./.github/actions/build-setup
        with:
          cachixAuthToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          system: aarch64-linux
      - name: Update flake inputs
        run: |
          nix flake update \
          | tee --output-error /dev/tty \
            1> update.stdout \
            2> update.stderr;
          exit "${PIPESTATUS[0]}"
      - name: Cache flake.lock
        uses: actions/cache@v4.0.2
        with:
          path: flake.lock
          key: flake-lock-${{ github.sha }}
      - name: Cache update results
        uses: actions/cache@v4.0.2
        with:
          path: |
            update.stdout
            update.stderr
          key: update-${{ github.sha }}

  check:
    name: Run flake checks
    needs: update
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: ./.github/actions/build-setup
        with:
          cachixAuthToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          forceInstallQemu: true
      - name: Restore cached flake.lock
        uses: actions/cache/restore@v4.0.2
        with:
          path: flake.lock
          key: flake-lock-${{ github.sha }}
      - name: Run flake checks
        run: |
          nix flake check \
          | tee --output-error /dev/tty \
            1> check.stdout \
            2> check.stderr;
          exit "${PIPESTATUS[0]}"
      - name: Cache check results
        uses: actions/cache@v4.0.2
        with:
          path: |
            check.stdout
            check.stderr
          key: check-${{ github.sha }}

  create-pr:
    name: Create PR
    needs:
      - update
      - check
    runs-on: ubuntu-latest
    steps:
      - name: Restore cached update results
        uses: actions/cache/restore@v4.0.2
        with:
          path: |
            update.stdout
            update.stderr
          key: update-${{ github.sha }}
      - name: Restore cached test results
        uses: actions/cache/restore@v4.0.2
        with:
          path: |
            check.stdout
            check.stderr
          key: check-${{ github.sha }}
      - name: Set variables
        id: vars
        run: |
          {
            echo "update-stdout=$(cat update.stdout)"
            echo "update-stderr=$(cat update.stderr)"
            echo "check-stdout=$(cat check.stdout)"
            echo "check-stderr=$(cat check.stderr)"
          } > "$GITHUB_OUTPUT"
      - name: Create PR
        uses: technote-space/create-pr-action@v2
        with:
          COMMIT_MESSAGE: 'chore: Update flake inputs'
          PR_TITLE: 'chore: Update flake inputs'
          PR_BRANCH_NAME: update-flake-inputs
          PR_BODY: |
            ### Updated inputs

            <details open>
            ```sh
            ${{ steps.vars.outputs.update-stdout }}
            ```
            </details>

            ### Check results

            ```sh
            ${{ steps.vars.outputs.check-stdout }}
            ```
            <details>
            <summary>Warnings</summary>
            ```sh
            ${{ steps.vars.outputs.check-stderr }}
            ```
            </details>
          GITHUB_TOKEN: ${{ secrets.GHA_TOKEN }}
